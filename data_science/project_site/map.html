<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script src="//codeorigin.jquery.com/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <style type="text/css">

html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 60px;
  height: 20px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.pixel{opacity:0.5;}

    </style>
  </head>
  <body>
    <div id="map"></div>
    <script type="text/javascript">

      
var styles = [
  {
    "featureType": "road",
    "stylers": [
      { "visibility": "off" }
    ]
  },{
    "featureType": "poi",
    "stylers": [
      { "visibility": "off" }
    ]
  },{
    "featureType": "administrative.locality",
    "stylers": [
      { "visibility": "off" }
    ]
  },{
    "featureType": "landscape.man_made",
    "stylers": [
      { "visibility": "off" }
    ]
  },{
  }
];      
  
var styledMap = new google.maps.StyledMapType(styles,
    {name: "Styled Map"});      
      
// Create the Google Map…
var map = new google.maps.Map(d3.select("#map").node(), {
  zoom: 10,
  center: new google.maps.LatLng(42.335897, -71.096649),
   mapTypeControlOptions: {
      mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
    }
});
      
map.mapTypes.set('map_style', styledMap);
  map.setMapTypeId('map_style');      

// Load the station data. When the data comes back, create an overlay.


current_day = 150;

d3.csv("pixels.csv", function(csvin) {
  data = csvin;


  //data = _.sample(data, data.length / 5);

  _.each(data, function(o){
    o.lat = parseFloat(o.lat);
    o.lng = parseFloat(o.lng);
  })

  var sample = 3;

  var lats = _.pluck(data, 'lat');
  lats = _.uniq(lats).sort();
  lats.sort();
  var include_lats = {};

  _.each(lats, function(o,k){
    if(k % sample === 0)include_lats[o] = true;
  });

  var lngs = _.pluck(data, 'lng');
  lngs = _.uniq(lngs).sort();
  lngs.sort();
  var include_lngs = {};

  _.each(lngs, function(o,k){
    if(k % sample === 0)include_lngs[o] = true;
  });


  var tmp_data = [];
  _.each(data, function(o, k){
    //if(include_lats[o.lat] && include_lngs[o.lng])tmp_data.push(o);
    if(include_lats[o.lat] && k % sample === 0)tmp_data.push(o);
  });

  data = tmp_data;

  _.each(data, function(o){
    o.color = d3.scale.linear()
    .domain([0, +o.e1, +o.e2, +o.e3, +o.e4, +o.e5, +o.e6, +o.e7, +o.e8, +o.e9, 365])
    .range(["#A38C72", "#A38C72", "green", "green", "green", "green", "yellow", "orange", "red", "#A38C72", "#A38C72"]);
  });

  var overlay = new google.maps.OverlayView();

window.mymap = overlay;

  // Add the container when the overlay is added to the map.
  overlay.onAdd = function() {
    var layer = d3.select(this.getPanes().overlayLayer).append("div")
        .attr("class", "stations");

    // Draw each marker as a separate SVG element.
    // We could use a single SVG, but what size would it have?
    overlay.draw = function() {
      console.log('drawing');
      var projection = this.getProjection(),
          padding = 10;

      var marker = layer.selectAll("svg")
          .data(d3.entries(data))
          .each(transform) // update existing markers
        .enter().append("svg:svg")
          .each(transform)
          .attr("class", "marker");

      // Add a circle.
      /*
      marker.append("svg:circle")
          .attr("r", 4)
          .attr("cx", padding)
          .attr("cy", padding)
          .attr("class", "pixel");
          */

      marker.append("svg:rect")
          //.attr("r", 4)
          .attr("x", padding)
          .attr("y", padding)
          .attr("width", 10)
          .attr("height", 10)
          .attr("class", "pixel");    
          
      
      layer.selectAll(".pixel")
          .attr('style', function(d){return 'fill:' + d.value['color'](current_day)});

      /*
      // Add a label.
      marker.append("svg:text")
          .attr("x", padding + 7)
          .attr("y", padding)
          .attr("dy", ".31em")
          .text(function(d) { return d.key; });
      */

      function transform(d) {
        d = new google.maps.LatLng(d.value['lat'], d.value['lng']);
        d = projection.fromLatLngToDivPixel(d);
        return d3.select(this)
            .style("left", (d.x - padding) + "px")
            .style("top", (d.y - padding) + "px");
      }
    };
  };

  // Bind our overlay to the map…
  overlay.setMap(map);
});

    </script>


<div style='position:absolute; top:40px; right:10px; padding:10px; border: solid 1px #cecece; background-color:white;'>
  1 <input type="range" style='width:300px;' value='150' name="points" min="1" max="365" onchange="current_day=this.value; $('#current_day').html(this.value);  mymap.draw();"> 365
  <div id='current_day' style='text-align:center;'>150</div>
</div>    
  </body>
</html>